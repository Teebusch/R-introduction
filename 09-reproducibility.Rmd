# Reproducibility

::: {.goals}
-   Turning an RMarkdown notebook into a shareable document.
-   Using Git to track changes.
-   Using `{renv}` snapshots to manage package versions.
:::

Workflows that are based on graphical user interfaces are difficult to reproduce! In
contrast, when you code your analysis with R, all the steps are laid out in your script.
Well-written code allows to retrace everything you have done and it allows someone else to
understand how you got from your data to your results.

To ensure that your results are truly reproducible, you must take additional measures. You
need to make sure that your code produces the same results on another computer and at a
later point in time. Moreover you should provide enough documentation to allow others to
understand the motivation behind your analysis.

You may be thinking that nobody will care to reproduce your analysis. Even if this is
true, it is quite possible that *you* will at some later point get back to it, and your
future self will certainly thank you for making their job as easy as possible.

## Self-contained projects with RStudio

You have already learned how to store your analysis as a self-contained *RStudio project*.
This was the first step to reproducibility, because RStudio projects are portable and
self-contained.

In addition, you should get familiar with best practices for organizing and naming the
files in your project folder. As a primer, I recommend reading *Good Enough Practices for
Scientific Computing* [@wilsonGoodEnoughPractices2017]. A few of the key points are:

-   Store your data in a `data/` directory. Keep your raw data as raw as possible.
-   ...
-   ...

## Reproducible reports with RMarkdown

Another tool for reproducible analyses that we have already introduced is *RMarkdown*. In
an *RMarkdown* document, you can mix text, R code, and the output of that R code.

With the click of a button, you can turn this into a self-contained document (an HTML
page, a PDF, a Word file) that you can share with others. No more copy and paste!

``` {.r}
# ...
```

[You can use this to make websites, slides, or even write
papers](https://rmarkdown.rstudio.com/lesson-1.html). And if a reviewer asks you to
exclude a subject? Remove the data point and click the button again --- all the figures
and stats update! Without ever leaving RStudio,
[RMarkdown](https://bookdown.org/yihui/rmarkdown/) allows you to make

-   reports
-   papers with [`{papaja}`](https://github.com/crsh/papaja),
    [`{rticles}`](https://github.com/rstudio/rticles)
-   books with [`{bookdown}`](https://bookdown.org/)
-   websites, blogs with [`{blogdown}`](https://github.com/rstudio/blogdown),
    [`{hugodown}`](https://hugodown.r-lib.org/),
    [`{distill}`](https://rstudio.github.io/distill/)
-   slides with [`{xaringan}`](https://github.com/yihui/xaringan),
    [`{xaringanthemer}`](https://github.com/gadenbuie/xaringanthemer)
-   [teaching with
    {learnR}](https://tinystats.github.io/teacups-giraffes-and-statistics/02_bellCurve.html)
-   [RMarkdown with parameters](https://rmarkdown.rstudio.com/lesson-6.html) for simple
    tools, recurring tasks/reports, ..

Resources:

-   [RMarkdown - The definitive Guide](https://bookdown.org/yihui/rmarkdown/) -- A deep
    dive into RMarkdown
-   [RMarkdown for Scientists](https://rmd4sci.njtierney.com/) -- A guide to RMarkdown
    aimed at researchers
-   Packages to make pretty APA [tables for
    models](http://www.danieldsjoberg.com/gtsummary/index.html),
    [summary](https://cran.r-project.org/web/packages/table1/vignettes/table1-examples.html)
    [stats](https://cran.r-project.org/web/packages/sjPlot/vignettes/tab_model_estimates.html),
    ...
-   Interface with Microsoft Office - Excel, Word, PowerPoint with
    [`{officeR}`](https://davidgohel.github.io/officer/)

## Version control with Git

Version control is an essential tool for any serious programming. It is like a time
machine for your code. Among other things, version control allows you to

-   store the state of your project and restore a previous state.

-   create parallel versions (branches) of your code, switch between them and merge them
    back together

-   collaborate with others on the same code, review and merge the changes that others
    have made

Using version control is very liberating because it gives you the freedom to experiment
and make mistakes.

A popular version control tool is [Git](https://git-scm.com/). To start using Git with
your project you will need to do four things:

1.  **Install Git**

2.  **initialize a new Git repository** in your project directory.

3.  **Decide which files and changes you want to save** --- there may be some files that
    you do not really need to track. For example, large intermediate data files may not be
    worth tracking if they can be easily recreated from the code.

4.  **Commit the current state** --- A *Git commit* is to code what the ðŸ’¾ is to a Word
    document.

In principle you could use Git in the terminal, but there are many graphical user
interfaces for Git that make things easier, and RStudio has a Git interface built
in.[^reproducibility-1]

[^reproducibility-1]: Personally, I prefer Github Desktop (<https://desktop.github.com/>)
    because it is prettier, snappier, and arguably more user friendly.

``` {.bash}
git init
git add . 
git commit -m "initial commit"
```

Congratulations! You have made your first Git commit! Now you can rest assured, that you
can always go back to the current state of the analysis, see the changes you have made
since, figure out where things broke, and undo changes if necessary. Isn't that a
comforting feeling?

To utilize the full power of Git, you will have to learn a few more things. This is
outside of the scope of this book but you can find a good introduction to Git for R users
in the book *Happy Git with R* (<https://happygitwithr.com/>). Learn to use Git and use it
often!

## Snapshot your packages with {renv}

Unfortunately, using Git to track changes in your *own* code not enough, because the
packages that you use may get updated too. Sometimes the developers decide to change the
way a function works, and this can cause your code to break. It can be really frustrating
to find that your analysis from a few months ago suddenly does not run anymore, or that it
fails to run on your collaborators computer, who uses different package versions. You can
save yourself the trouble by storing a snapshot of your package library using the
[`{renv}`](https://rstudio.github.io/renv/) package [@R-renv].

Install the `{renv}` package, then -- in your project initialize `{renv}` for your project
and take a snapshot of the packages you use in your project:

```{r, eval=FALSE}
install.packages("renv")
renv::init()
renv::snapshot()
```

This creates a private, per-project library, in which new packages will be installed. This
library is isolated from other R libraries on your system. Later, you or your
collaborators can recreate this library, with the exact package versions you used by
running `renv::restore()`.

## Snapshot everything with Docker

R itself receives updates, too. While the updates are often minor and breaking changes are
rare, it is not guaranteed that today's code will work on a future version of R.

It is possible to install multiple versions of R in parallel on the same computer and
switch between them relatively easily in the RStudio interface.

You can also take the idea of snapshotting your environment a step further by using
[Docker Containers](https://www.rocker-project.org/). This is akin to creating an entire
virtual computer just for your analysis. Instead of just your analysis files, you then
track, store, and share that entire virtual computer. This is a lot more effort, but it
may be the only way to guarantee that your analysis can be runreproduced out of the box.
However, this is beyond the scope of this book.

## More

R has many more tools for improving reproducibility, and as always there's more than one
option.

### Pipelines

Once your analysis becomes more complex it often contains many different outputs (models,
figures, intermediate data sets). Some of them can take long to compute and it can be
difficult to stay on top of the different steps of your analysis. There are packages that
try to solve that.

-   [`{targets}`](https://books.ropensci.org/targets/) - smart make-files for your
    analysis
-   [`{orderly}`](https://www.vaccineimpact.org/orderly/) - makes sure your reproducible
    reports are reproducible
-   `{rrtols}`

### Test-driven development

with `{testthat}, {tinytest}. {testrmd}`
